# 应用层

应用层（application-layer）的任务是通过应用进程间的交互来完成特定网络应用。应用层协议定义的是应用进程（进程：主机中正在运行的程序）间的通信和交互的规则。对于不同的网络应用需要不同的应用层协议。在互联网中应用层协议很多，如域名系统 DNS，支持万维网应用的 HTTP 协议，支持电子邮件的 SMTP 协议等等。我们把应用层交互的数据单元称为**报文**。



# 表示层

表示层（Presentation Layer），管理到网络上（数据流从其往下到协议栈）和到特定机器或是应用程序上（数据流从其往上到协议栈）的数据的表示方式。

无论发送方的表示层做了什么，接收方的表示层都必须予以复原，从而使连接的双方在某个时刻分享相似的数据视图。

表示层能够为应用程序提供**特殊的数据处理**功能。**协议变换**，当应用程序使用的协议不同于网络通信所用协议时，表示层会进行协议的变换，比如在电子商务、数据库或其他面向事务服务的情况下，或者是数据加密（对于出站消息）、数据解密（对于入站消息）、数据压缩（对于出站消息）、数据解压缩（对于入站消息）。



# 会话层

在发送方和接收方之间进行通信时创建、维持、之后终止或断开连接的地方，与电话通话有点相似。

会话层定义了一种机制，允许发送方和接收方启动或停止请求会话，以及当双方发生拥塞时仍然能保持对话。

会话层的主要任务是负责两个网络参与者之间进行的通信，这两个网络参与者在通信过程中通常交换一系列的**消息**或**PDU（协议数据单元）**。例如：用户登录到数据库上（**建立阶段**），输入一连串的查询（**数据交换阶段**），完成任务后退出登录（**断开阶段**）。



# 传输层

运输层（transport layer）的主要任务就是负责向两台主机进程之间的通信提供通用的数据传输服务。应用进程利用该服务传送应用层报文。“通用的”是指并不针对某一个特定的网络应用，而是多种应用可以使用同一个运输层服务。



由于一台主机可同时运行多个线程，因此运输层有复用和分用的功能。所谓复用就是指多个应用层进程可同时使用下面运输层的服务，分用和复用相反，是运输层把收到的信息分别交付上面应用层中的相应进程。



# 网络层

在计算机网络中进行通信的两个计算机之间可能会经过很多个数据链路，也可能还要经过很多通信子网。网络层的任务就是选择合适的网间路由和交换结点（通过IP寻址）， 确保数据及时传送。在发送数据时，网络层把运输层产生的报文段或用户数据报封装成分组和包进行传送。在 TCP / IP 体系结构中，由于网络层使用 **IP 协议**，因此分组也叫 IP 数据报，简称数据报。



# 数据链路层

数据链路层（data link layer）通常简称为链路层。两台主机之间的数据传输，总是在一段一段的链路上传送的，这就需要使用专门的链路层的协议。在两个相邻节点之间传送数据时，数据链路层将网络层交下来的 IP 数据报组装成帧，在两个相邻节点间的链路上传送帧。每一帧包括数据和必要的控制信息（如：同步信息，地址信息，差错控制等）。



在接收数据时，控制信息使接收端能够知道一个帧从哪个比特开始和到哪个比特结束。这样，数据链路层在收到一个帧后，就可从中提出数据部分，上交给网络层。控制信息还使接收端能够检测到所收到的帧中有无差错。如果发现差错，数据链路层就简单地丢弃这个出了差错的帧，以避免继续在网络中传送下去白白浪费网络资源。如果需要改正数据在链路层传输时出现差错（这就是说，数据链路层不仅要检错，而且还要纠错），那么就要采用可靠性传输协议来纠正出现的差错。这种方法会使链路层的协议复杂些。



所以这一层的作用为**封装成帧、差错检验**



# 物理层

在物理层上所传送的数据单位是比特。物理层（physical layer）的作用是实现相邻计算机节点之间比特流的透明传送，尽可能屏蔽掉具体传输介质和物理设备的差异。使其上面的数据链路层不必考虑网络的具体传输介质是什么。“透明传送比特流”表示经实际电路传送后的比特流没有发生变化，对传送的比特流来说，这个电路好像是看不见的。



# 生动形象理解七层模型

https://shimo.im/docs/e1Az4VEMrGSPbbqW/ 《OSI七层模型》



# 协议详解

![img](https://uploader.shimo.im/f/X1GkmyyxzZI1BTSw.png!thumbnail)

## ARP协议（网络层和链路层）

网络层的 ARP 协议完成了 IP 地址与物理地址的映射。首先，每台主机都会在自己的 ARP 缓冲区中建立一个 ARP 列表，以表示 IP 地址和 MAC 地址的对应关系。当源主机需要将一个数据包要发送到目的主机时，会首先检查自己 ARP 列表中是否存在该 IP 地址对应的 MAC 地址：如果有，就直接将数据包发送到这个 MAC 地址；如果没有，就向本地网段发起一个 ARP 请求的广播包，查询此目的主机对应的 MAC 地址。



此 ARP 请求数据包里包括源主机的 IP 地址、硬件地址、以及目的主机的 IP 地址。网络中所有的主机收到这个 ARP 请求后，会检查数据包中的目的 IP 是否和自己的 IP 地址一致。如果不相同就忽略此数据包；如果相同，该主机首先将发送端的 MAC 地址和 IP 地址添加到自己的 ARP 列表中，如果 ARP 表中已经存在该 IP 的信息，则将其覆盖，然后给源主机发送一个 ARP 响应数据包，告诉对方自己是它需要查找的 MAC 地址；源主机收到这个 ARP 响应数据包后，将得到的目的主机的 IP 地址和 MAC 地址添加到自己的 ARP 列表中，并利用此信息开始数据的传输。如果源主机一直没有收到 ARP 响应数据包，表示 ARP 查询失败。





## DNS协议（应用层）

https://shimo.im/docs/NJkbEZwQ2auGGgqR/ 



## DHCP协议（应用层）

动态主机设置协议（Dynamic Host Configuration Protocol, DHCP）是一个局域网的网络协议，使用UDP协议工作，主要有两个用途：

- 给内部网络或网络服务供应商自动分配IP地址给用户

- 给内部网络管理员作为对所有电脑作中央管理的手段



**也就是说是给局域网内部节点自动分配IP地址的。**



## ICMP协议（网络层）

Internet Control Message Protocol，也就是Internet控制消息协议。

用于在IP主机、路由器之间传递**控制消息**（指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。）

主机探测、路由维护、路由选择、流量控制。我们常用的ping命令和traceroute命令都是通过ICMP协议来实现的。



## TCP/UDP协议（传输层）

### **TCP（****Transmission Control Protocol****）：传输控制协议**

TCP是面向连接的、可靠的、基于字节流的传输层通信协议，把连接作为最基本的对象，每一条TCP连接都有两个端点，这种断点我们叫作套接字（socket），它的定义为端口号拼接到IP地址即构成了套接字，例如，若IP地址为127.0.0.1 而端口号为80，那么得到的套接字为127.0.0.1 :80。



**报文格式如下**

![img](https://uploader.shimo.im/f/IjDxTg1aD9xMzJ3U.png!thumbnail)



#### 保证可靠传输的措施：

1. 连接管理：TCP是面向连接的，三次握手和四次挥手都保证了本次数据传送的可靠性。



1. 序列号：保证数据段的按序到达，TCP是面向字节流的，它对每一个字节都进行了编号，接收端也是根据序号来对收到的数据进行排序，如果中间有某个数据报丢了，则之后的数据报还是会接受，但是不会对发送端返回之后的确认，而是会重复发送对丢失处之前数据的确认，保证发送端会对丢失数据段进行重发。



1. 超时重传机制：当TCP发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。  



1. 流量控制：根据接收端处理数据的能力来控制发送端发送数据的速度。接收端将自己接收缓冲区的空闲空间的大小填充到TCP的报文头部中的窗口大小的字段中，通过ACK确认应答发送给发送端。如果接收端的接收缓冲区快满了，接收端就会将窗口大小设置为一个更小的值发送给发送端，这时发送端的发送速度就会减缓；如果接收端接收缓冲区彻底满了，接收端就会将窗口大小设置为0，这时发送端便停止发送数据段，但是会定时的发送一个窗口探测报文，以此来获取接收端的接收缓冲区状态。



1. 拥塞控制：TCP的拥塞控制由4个核心算法组成“慢启动”（Slow Start）、“拥塞避免”（Congestion voidance）、“快速重传 ”（Fast Retransmit）、“快速恢复”（Fast Recovery）。



首先需要了解一个概念，为了在发送端调节所要发送的数据量，定义了一个“拥塞窗口”，在发送数据时。拥塞控制主要是四个算法：

1. 慢启动：当主机开始发送数据的时候，如果立刻把大量的数据字节注入到网络，那么可能会引起网络阻塞和丢包，因为目前主机还不知道网络状况。所以这种思想是**先试探一下，根据网络状况由小到大增大发送窗口，也就是由小到大逐渐增大拥塞窗口数值，没经过一次传播，窗口大小加倍**。

1. 拥塞避免：让拥塞窗口缓慢增大，每经过一次传播，窗口大小加一

1. 快重传：![img](https://uploader.shimo.im/f/yqJki9tWpmz7hWpB.png!thumbnail)

一旦接收方连续 3 次收到同一个重复确认就会立马启动快重传算法，即立马重传 M3，而不会等待 M3 的超时时间到期，并且转入慢开始阶段（老版本没有利用快恢复算法，而现在的版本并不会直接进入）。

1. 快恢复：

快恢复是配合快重传使用的。上图所示的3号报文 丢失，可能是因为3号报文在某个节点因为网络波动等非网络拥挤情况阻塞住了。也就是网络其实并没有拥塞，快恢复就是在此情况下避免直接重传会真正导致网络阻塞，其原理就是先将拥塞窗口设置成 ssthresh 的大小，然后执行拥塞避免算法。

![img](https://uploader.shimo.im/f/OKPUU5WWIcQ5mRfp.png!thumbnail)

**三次握手**

https://shimo.im/docs/Ee32M7Wa47UM1WA2/ 



### UDP（User Datagram Protocol）：用户数据报协议。

在数据传输之前不需要建立连接，远地主机在收到UDP后，不需要给出任何确认。虽然UDP不提供可靠交付，但在某些情况下UDP是一种最有效的工作方式（即时通信），比如QQ语音、直播等。



## Http协议（应用层）

https://shimo.im/docs/RKAWVaYWyQs8XGk8/ 《Http版本》

https://shimo.im/docs/N2A1MEPazZi6YMAD/ 《Http和Https》

https://shimo.im/docs/47kgJ2Dx2EI6nDqV/ 《https原理详解》